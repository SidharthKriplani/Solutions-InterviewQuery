https://www.interviewquery.com/questions/identifying-user-sessions

SQL:

WITH EventsWithPrevious AS 
(SELECT ID, CREATED_AT, USER_ID, EVENT,
COALESCE(TIMESTAMPDIFF(MINUTE, LAG(CREATED_AT) OVER(PARTITION BY USER_ID ORDER BY CREATED_AT), CREATED_AT), 0) AS MINUTES_SINCE_LAST_EVENT
FROM EVENTS ),

Sessions AS 
(SELECT *,
CASE 
WHEN MINUTES_SINCE_LAST_EVENT > 60 OR MINUTES_SINCE_LAST_EVENT = 0 THEN 1 ELSE 0 END AS IS_NEW_SESSION
FROM EventsWithPrevious),

CumulativeSessions AS 
(SELECT CREATED_AT, USER_ID, EVENT, 
SUM(IS_NEW_SESSION) OVER (PARTITION BY USER_ID ORDER BY CREATED_AT) AS SESSION_ID
FROM Sessions)

SELECT CREATED_AT, USER_ID, EVENT, SESSION_ID
FROM CumulativeSessions
ORDER BY 2, 1


PYTHON:

